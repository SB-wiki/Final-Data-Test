---
icon: elementor
---

# Cassandra, Neo4j, ES Restore

Restore Steps:

**Neo4j Restore:**

1. Stop neo4j and delete “ **/home/learning/neo4j-learning/neo4j-enterprise-{version}/data/databases/graph.db”** folder of the newly provisioned neo4j service.

**sudo su learning**

**cd /home/learning/neo4j-learning/neo4j-enterprise-3.3.0/bin**

**./neo4j start** #To start the service

**./neo4j stop** #To stop the service

1. Download the latest or the specific date backup from azure storage (ntpstagingall(or)ntpproductionall/neo4j-backup) and unzip it to a directory.
2. Rename unzip backup to **“graph.db”** and change the ownership permission to learning user.
3. Copy graph.db folder to path “**/home/learning/neo4j-learning/neo4j-enterprise-3.3.0/data/databases**”
4. Now, start neo4j

**Validation:**

1. **Go to neo4j shell:**

cd \`/neo4j-learning/neo4j-enterprise-3.3.00

bin/cypher-shell

**2.** **Query to execute**:

MATCH (n:domain) return COUNT(n);

**Hints:** Azure cli to download from azure blob:

az storage blob download --container-name <> --name <> --file <> --output table

\--account-name <> --account-key <>

**Command to start and stop neo4j:**

switch to learning user:

**sudo su learning**

**cd /home/learning/neo4j-learning/neo4j-enterprise-3.3.0/bin**

**./neo4j start** #To start the service

**./neo4j stop** #To stop the service

**Cassandra Restore for LP and DP Steps:**

1. **Installation:** [https://www.rosehosting.com/blog/how-to-install-apache-cassandra-on-ubuntu-16-04/](https://www.rosehosting.com/blog/how-to-install-apache-cassandra-on-ubuntu-16-04/)

Or provision cassandra in only one node

Add below in preprod host file of test branch

\[cassandra]

IP

Comment all the other cassandra ip’s

[http://10.20.0.9:8080/job/Provision/job/pre-production/job/Core/job/Cassandra/](http://10.20.0.9:8080/job/Provision/job/pre-production/job/Core/job/Cassandra/)

1. Download backup from azure blob ( ntpbackupstaging(or) ntpbackupsproduction/cassandra-backup) to cassandra vm and unzip it to a directory.
2. Now create a schema using the below command.

cmd : “**cqlsh -f db\_schema.cql”** (schema file will be in backup folder)

1. Copy/Download the cassandra restore script to the vm using the below link (cassandra\_restore.py)

[https://github.com/project-sunbird/sunbird-devops/blob/release-2.1.0/deploy/cassandra\_restore.py](https://raw.githubusercontent.com/project-sunbird/sunbird-devops/release-2.1.0/deploy/cassandra\_restore.py)

1. Run the restore file to using the below cmd to restore it.

cmd : “ **./cassandra\_restore.py --host $(hostname -i) \<backup folder>”**

**Cmd: “./cassandra\_restore.py --host localhost --snapshotdir cassandra\_backup”**

5\. To verify count of data in table

**Use keyspace\_name**;

**select count(\*) from prod\_content\_hierarchy ;**

**Script to count the number of rows:**

[**https://github.com/project-sunbird/sunbird-devops/blob/release-2.10.0/deploy/utilities/cassandra\_row\_counter.py**](https://github.com/project-sunbird/sunbird-devops/blob/release-2.10.0/deploy/utilities/cassandra\_row\_counter.py)

**For Cluster restore ( Restore to a single server)**

1. Download all the( 3 backup) backup files.
2. Edit any one of the db\_schema.cql and replace
   1. “{ 'class': 'NetworkTopologyStrategy', 'datacenter1': '2'} ” **to** “ { **'**class': 'SimpleStrategy', 'replication\_factor': '1' } “
3. DELETE keyspaces which got generated by the provision job **except** system related keyspace mentioned below.
   1. system\_auth system system\_distributed system\_schema system\_traces
4. And then restore the schema. ( only one schema file is enough)
   1. **cqlsh -f db\_schema.cql**
5. Copy/Download the cassandra restore script to the vm using the below link (cassandra\_restore.py)

[https://raw.githubusercontent.com/project-sunbird/sunbird-devops/release-2.1.0/deploy/cassandra\_restore.py](https://raw.githubusercontent.com/project-sunbird/sunbird-devops/release-3.2.0/deploy/cassandra\_restore.py)

Execute below alter tables before executing **5th** step.

**ALTER TABLE sunbird.user add (aadhaarno text);**

**ALTER TABLE sunbird.user add (regorgid text);**

**ALTER TABLE sunbird.user add (provider text);**

**ALTER TABLE sunbird.organisation ADD contactDetails map\<text,text>;**

**ALTER TABLE sunbird.user\_skills ADD endorsers Map\<text , text>;**

**ALTER TABLE sunbird.user\_org ADD addedby text;** # this issue is not in

release-1.9 ntp-prod

**ALTER TABLE sunbird.user\_skills add ( addedby text, addedat text); #**this

issue in ntp-prod

**ALTER TABLE sunbird.organisation ADD source text;**

1. Now use the below command and restore the data from the untarred directories.
   1. **./cassandra\_restore.py --host localhost --snapshotdir cassandra\_backup\_1**
   2. **./cassandra\_restore.py --host localhost --snapshotdir cassandra\_backup\_2**
   3. **./cassandra\_restore.py --host localhost --snapshotdir cassandra\_backup\_3**

**Cassandra Validation:**

1. To list the keyspaces,

**DESCRIBE KEYSPACES;**

2\. Take random keyspaces by using below command,

**USE ntpprod\_platform\_db ;**

3\. Describe the table,

**DESCRIBE tables;**

4\. To get the count for a specific table and compare the count with other cassandra.

**select \* from job\_request;**

**Cassandra Restore for LMS**:

1. Backup are stored in path (ntpbackupsstaging(or)ntpbackupsproduction/cassandra-backup)
2. For LMS cassandra restoration, there would be expected error while restoring. If we get error related to aadhar column, then would need to follow the below steps.

**ALTER TABLE sunbird.user add (aadhaarno text);**

**ALTER TABLE sunbird.user add (regorgid text);**

**ALTER TABLE sunbird.user add (provider text);**

**ALTER TABLE sunbird.organisation ADD contactDetails map\<text,text>;**

**ALTER TABLE sunbird.user\_skills ADD endorsers Map\<text , text>;**

**ALTER TABLE sunbird.user\_org ADD addedby text;** # this issue is not in

release-1.9 ntp-prod

**ALTER TABLE sunbird.user\_skills add ( addedby text, addedat text); #**this

issue in ntp-prod

**Some Error:**

Failed to list files in “””cassandra\_backup/sunbird/organisation-84f255706e0711e7beb4033d1dd5270c

java.lang.RuntimeException: Unknown column source during deserialization

java.lang.RuntimeException: Failed to list files in cassandra\_backup/sunbird/organisation-84f255706e0711e7beb4033d1dd5270cALTER “”

**ALTER TABLE sunbird.organisation ADD source text;** (edited)

**Postgres-LMS Restore Process:**

1. Download the Latest backup using the azure cli cmd:
   1. “**az storage blob download --container-name postgresql-backup --name postgresql\_backup\_UTC-2018-11-19-21-08-26.sql.gz --file postgresql\_backup\_UTC-2018-11-19-21-08-26.sql.gz --account-name ntpbackupsproduction --account-key <>**”
2. Rename the file using the below cmd,
   1. **zcat postgresql\_backup\_UTC-2018-11-19-21-08-26.sql.gz > postgresql\_backup.sql**
3. Switch to postgress user,
   1. **sudo su postgres**
4. psql postgres < postgresql\_backup.sql

**Validation Steps:**

To validate data login to psql console using below cmd,

*
  1. **psql**
  2. Other cmd’s,,
     1. **\l** (all db list)
     2. **\c keycloak** (use db)
     3. **\dt** (show all tables)

**Elasticsearch Restore**

**Wiki:**

[https://github.com/project-sunbird/sunbird-dePayloadTooLargeErrorvops/wiki/elasticsearch-backup-and-restore-for-telemetry-and-composite-search-to-azure-blob](https://github.com/project-sunbird/sunbird-devops/wiki/elasticsearch-backup-and-restore-for-telemetry-and-composite-search-to-azure-blob)

* Launch Servers, add it in hosts file as a group and give the Server Private IP as a parameter in Jenkins Job,
* You can find the snapshot ID of the latest index with the below curl command.

**Command:** curl -s -XGET http://$(hostname -i):9200/\_snapshot/{blob\_name\_or\_repo\_name}/\_all

* Install ES Azure Plugin in all the nodes if cluster, and configure the container to which it need to talk.(**Refer The Wiki**)
* \#To check the status of snapshot restore **curl -XGET “http://localhost:9200/\_snapshot/azurebackup/\_all?pretty=true”**

**Elasticsearch Validation:-**

* Check the indices sizes, docs, counts and compare to the production or the respective data.

**Grafana:**

**Backup steps:**

**Note:** As of now backup and restore is manual steps.

1\. Upload the grafana.db file to storage.

**Path in normal vm:** /var/lib/grafana/grafana.db

**Path in dockerized:** /var/dockerdata/grafana

**Restore Steps:**

1. Install the grafana
2. install the az cli/aws cli
3. Download the backup file to vm and unzip/untar the same
4. Stop the grafana service and remove the /var/lib/grafana/grafana.db
5. Copy the backup grafana.db file to /var/lib/grafana/
6. start the grafana service and browse it.

**Validation:**

1. Select the random dashboards and compare the queries.

**Prometheus Restore:**

1. Test-server setup with monitor stack from sunbird-devops repo.
2. Bring down the prometheus service,

“**sudo docker service scale monitor\_prometheus=0**”

1. Download backup file from azure storage,
   1. **sudo az storage blob download --container-name prometheus-backup --name prometheus\_backup\_UTC-2018-11-22-20-39-14.tar.gz --file prometheus\_backup\_UTC-2018-11-22-20-39-14.tar.gz --account-name ntpbackupsproduction --account-key <>**
2. Untar the downloaded file,
   1. **tar xvf prometheus\_backup\_UTC-2018-11-22-20-39-14.tar.gz**
   2. **sudo cp -r mnt/dockerdata/prometheus/data /mnt/dockerdata/prometheus/data**
3. Bring up the prometheus service using the below command,
   1. **sudo docker service scale monitor\_prometheus=1**

**Jenkins:**

1. Install thinbackup plugin and do sample backup in test-server where jenkins is installed.
2. Download the jenkins-backup file from azure storage.
3. Copy backup folder to the thinbackup path.
4. Click on Restore and select it.

**Influxdb:**

1. Install the influxdb and azure cli/aws cli.
2. Download backup from storage.
3. Execute the restore command,
   1. **influxd restore -portable \<backup-path> == > restore all databases**
   2. **influxd restore -db monitoring\_events -portable \<backup-path> ==> restore specific db**
4. **To login to console.**

$Influx

$Show databases ( Check the DB names)

$Use database (use monitoring\_events)

$SHOW SERIES ( prints the series of data)

**Postgres**

1. Click on restore on the currently available managed service.

\---> Provide the date ( For which the data needs to be restored.)

\---> Restore\_server\_Name ( New name that needs to be given)

1. **Click Ok**

**Redis Backup-Restore:**

1. **Installations.**
2. **Tcl installation :**

sudo apt-get update

sudo add-apt-repository main

sudo apt-get update

sudo apt-get install tcl

Refs: [**https://askubuntu.com/questions/1001223/sudo-apt-get-install-tcl8-5-dev-tk8-5-dev**](https://askubuntu.com/questions/1001223/sudo-apt-get-install-tcl8-5-dev-tk8-5-dev)

1. **Redis Installation:** [**https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-redis-on-ubuntu-16-04**](https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-redis-on-ubuntu-16-04)
2. **Stop the redis db**
   1. Sudo service redis stop
3. Download the dump.rdb file
4. **Rename** the dump.rdb file present in the /home/analytics/redis-stable and then,
5. **Copy** the downloaded dump.rdb file to /home/analytics/redis-stable and change the permission of the file to redis user ( sudo chown -R redis:redis dump.rdb)
6. **Start** the Redis-cli
   1. Sudo service redis start
7. **Login** to redis-cli
8. Type cmd: **info**
9. If there are any db’s in the output then use below cmd to get the keys count.
   1. **Select 1** ( where 1 is db1)
   2. **Keys \***
   3. ![](<../../../../.gitbook/assets/0 (6).png>)

![](<../../../../.gitbook/assets/1 (2).png>)

1. **Document Refs of Restore redis dump:** [**https://www.digitalocean.com/community/tutorials/how-to-back-up-and-restore-your-redis-data-on-ubuntu-14-04**](https://www.digitalocean.com/community/tutorials/how-to-back-up-and-restore-your-redis-data-on-ubuntu-14-04)

Composite Search errors

Production

![](<../../../../.gitbook/assets/2 (1).png>)

Restoring VM

![](<../../../../.gitbook/assets/3 (1).png>)

ES-LSM: Prod

![](<../../../../.gitbook/assets/4 (1).png>)

Es-lms: Restore Data:

![](<../../../../.gitbook/assets/5 (1).png>)

| Date            | Nov 30th | Nov 29th | Nov 28th | Nov 27th | Nov 26th | Nov 25th | Nov 24th |
| --------------- | -------- | -------- | -------- | -------- | -------- | -------- | -------- |
| Status          | Failed   | Success  | Failed   | Success  | Failed   | Success  | Failed   |
| Start Time -IST | 3:00     | 3:00     | 3:15     | 3:15     | 3:00     | 3:00     | 3:00     |
| End Time -IST   | --       | 6:26     | ---      | 5:18     | ---      | 7:54     | ---      |
